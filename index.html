<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Detector de Objetos IA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- SDK de AWS en el navegador -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1001.0.min.js"></script>

    <style>
        :root {
            --primary: #ff9900;
            --primary-dark: #ec8d00;
            --bg: #0f172a;
            --card-bg: #020617;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --border-subtle: #1f2937;
            --error: #f97373;
            --success: #4ade80;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text-main);
            background: radial-gradient(circle at top, #1f2937, #020617 55%, #000 100%);
            display: flex;
            justify-content: center;
            align-items: stretch;
            padding: 24px 12px;
        }

        .app {
            width: 100%;
            max-width: 960px;
            margin: auto;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
        }

        header h1 {
            margin: 0;
            font-size: 2rem;
            letter-spacing: 0.02em;
        }

        header p {
            margin: 8px 0 0;
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        main {
            margin-bottom: 18px;
        }

        .grid {
            display: grid;
            gap: 16px;
            grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .card {
            background: rgba(2, 6, 23, 0.96);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            padding: 18px 18px 16px;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
        }

        .card h2 {
            margin: 0 0 6px;
            font-size: 1.1rem;
        }

        .card h3 {
            margin: 0 0 6px;
            font-size: 1rem;
        }

        .card p {
            margin: 0 0 10px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .credenciales-box {
            font-size: 0.78rem;
            background: rgba(15, 23, 42, 0.9);
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px dashed #334155;
            color: var(--text-muted);
        }

        label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
            margin-bottom: 4px;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            border-radius: 999px;
            border: 1px solid #1f2937;
            padding: 9px 12px;
            font-size: 0.85rem;
            background: #020617;
            color: var(--text-main);
            outline: none;
            transition: border 0.15s, box-shadow 0.15s, background 0.15s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(249, 115, 22, 0.5);
            background: #020617;
        }

        .upload-zone {
            border: 1px dashed #334155;
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s, transform 0.15s;
            margin-top: 6px;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(15, 23, 42, 0.8);
            transform: translateY(-1px);
        }

        .upload-zone strong {
            color: var(--primary);
        }

        .upload-zone span {
            display: block;
            font-size: 0.85rem;
            margin-top: 4px;
            color: var(--text-muted);
        }

        input[type="file"] {
            display: none;
        }

        .file-info {
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .actions {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        button {
            border: none;
            border-radius: 999px;
            padding: 10px 18px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s, box-shadow 0.15s, opacity 0.15s;
        }

        .btn-primary {
            background: var(--primary);
            color: #111827;
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.55);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 16px 35px rgba(249, 115, 22, 0.55);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid #374151;
        }

        .status {
            margin-top: 10px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
        }

        .status span.badge {
            width: 9px;
            height: 9px;
            border-radius: 999px;
            display: inline-block;
            background: #6b7280;
        }

        .status--success span.badge {
            background: var(--success);
        }

        .status--error span.badge {
            background: var(--error);
        }

        .status--loading span.badge {
            background: var(--primary);
            animation: pulse 0.9s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(0.9); opacity: 0.6; }
            to { transform: scale(1.2); opacity: 1; }
        }

        .preview {
            margin-top: 12px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #1f2937;
            background: #020617;
            display: flex;
            align-items: center;
            justify-content: center;
            max-height: 260px;
        }

        .preview img {
            max-width: 100%;
            max-height: 260px;
            display: block;
        }

        .placeholder {
            padding: 32px 16px;
            font-size: 0.9rem;
            color: #4b5563;
            text-align: center;
        }

        .error-text {
            color: var(--error);
            font-size: 0.8rem;
            margin-top: 6px;
        }

        .results-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
        }

        .results-header small {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .empty-state {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        footer {
            margin-top: 18px;
            text-align: center;
            font-size: 0.75rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
<div class="app">
    <header>
        <h1>Detector de Objetos con AWS</h1>
        <p>Sube una imagen a S3, procesa con Lambda + Rekognition y consulta resultados en DynamoDB.</p>
    </header>

    <!-- VISTA 1: SOLO LOGIN / CREDENCIALES -->
    <main id="viewLogin">
        <section class="card" id="cardCredenciales">
            <h2>Iniciar sesi√≥n con credenciales del Learner Lab</h2>
            <p>Cop√≠a y pega los datos de <strong>AWS Details</strong> (Access Key, Secret Key y Session Token) para entrar a la app.</p>
            <div class="credenciales-box">
                Estos datos se guardan solo en tu navegador y se usan para firmar las llamadas a S3 y DynamoDB.
            </div>

            <label for="accessKey">AWS Access Key</label>
            <input type="text" id="accessKey" placeholder="AKIA..." />

            <label for="secretKey">AWS Secret Key</label>
            <input type="password" id="secretKey" placeholder="****************" />

            <label for="sessionToken">AWS Session Token</label>
            <input type="text" id="sessionToken" placeholder="Token de sesi√≥n completo" />

            <div class="actions">
                <button class="btn-primary" type="button" onclick="configurarAWS()">
                    Guardar credenciales y continuar
                </button>
            </div>
        </section>
    </main>

    <!-- VISTA 2: APP PRINCIPAL (SUBIR IMAGEN + RESULTADOS) -->
    <main id="viewMain" class="grid" style="display:none;">
        <div class="left-column">
            <!-- Tarjeta subida -->
            <section class="card" id="cardUpload">
                <h2>1. Selecciona una imagen</h2>
                <p>Formatos recomendados: JPG, PNG. El archivo se sube al bucket de entrada.</p>

                <label for="fileInput" class="upload-zone" id="uploadZone">
                    <div>üì∑ <strong>Haz clic aqu√≠</strong> para elegir una imagen</div>
                    <span>o arrastra y suelta un archivo</span>
                    <input type="file" id="fileInput" accept="image/*" />
                </label>

                <div class="file-info" id="fileInfo">Ning√∫n archivo seleccionado.</div>

                <div class="actions">
                    <button class="btn-primary" id="btnAnalizar" type="button" onclick="subirImagen()">
                        Analizar con IA
                    </button>
                    <button class="btn-secondary" type="button" onclick="limpiar()">Limpiar</button>
                </div>

                <div class="status" id="estado">
                    <span class="badge"></span>
                    <span>Esperando imagen...</span>
                </div>

                <div class="error-text" id="errorText"></div>

                <div class="preview" id="preview">
                    <div class="placeholder">Aqu√≠ ver√°s una vista previa de la imagen seleccionada.</div>
                </div>
            </section>
        </div>

        <!-- Tarjeta resultados -->
        <section class="card" id="cardResultados">
            <div class="results-header">
                <div>
                    <h2>2. Resultados (DynamoDB)</h2>
                    <small>Etiquetas guardadas en la tabla <code>TransripcionesAuto</code></small>
                </div>
            </div>
            <div id="resultado" class="empty-state">
                A√∫n no se ha realizado ning√∫n an√°lisis.
            </div>
        </section>
    </main>

    <footer>
        Proyecto de demostraci√≥n con S3, Lambda, Rekognition y DynamoDB.
    </footer>
</div>

<script>
    // CONFIGURACI√ìN
    const REGION = 'us-east-1';
    const BUCKET_ENTRADA = '__NOMBRE_BUCKET_PLACEHOLDER__';
    const TABLA_DYNAMO = 'TransripcionesAuto';

    let s3 = null;
    let docClient = null;
    let awsConfigured = false;

    const fileInput   = document.getElementById('fileInput');
    const uploadZone  = document.getElementById('uploadZone');
    const fileInfo    = document.getElementById('fileInfo');
    const estado      = document.getElementById('estado');
    const resultado   = document.getElementById('resultado');
    const preview     = document.getElementById('preview');
    const btnAnalizar = document.getElementById('btnAnalizar');
    const errorText   = document.getElementById('errorText');

    const viewLogin = document.getElementById('viewLogin');
    const viewMain  = document.getElementById('viewMain');

    // ==================== UI helpers ====================
    function setStatus(text, type = 'normal') {
        if (!estado) return;
        estado.classList.remove('status--success','status--error','status--loading');
        if (type === 'success') estado.classList.add('status--success');
        if (type === 'error')   estado.classList.add('status--error');
        if (type === 'loading') estado.classList.add('status--loading');
        estado.querySelector('span:nth-child(2)').innerText = text;
    }

    function actualizarInfoArchivo(file) {
        fileInfo.textContent = `Archivo seleccionado: ${file.name} (${Math.round(file.size / 1024)} KB)`;
        setStatus('Imagen seleccionada. Puedes analizarla.', 'success');
        errorText.textContent = '';
    }

    function mostrarPreview(file) {
        const reader = new FileReader();
        reader.onload = () => {
            preview.innerHTML = `<img src="${reader.result}" alt="Vista previa" />`;
        };
        reader.readAsDataURL(file);
    }

    function limpiar() {
        fileInput.value = "";
        fileInfo.textContent = "Ning√∫n archivo seleccionado.";
        preview.innerHTML = '<div class="placeholder">Aqu√≠ ver√°s una vista previa de la imagen seleccionada.</div>';
        resultado.className = 'empty-state';
        resultado.textContent = "A√∫n no se ha realizado ning√∫n an√°lisis.";
        errorText.textContent = '';
        setStatus('Esperando imagen...', 'normal');
    }

    // Drag & drop
    ['dragenter','dragover'].forEach(evt =>
        uploadZone.addEventListener(evt, e => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.style.borderColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--primary');
        })
    );

    ['dragleave','drop'].forEach(evt =>
        uploadZone.addEventListener(evt, e => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.style.borderColor = '#334155';
        })
    );

    uploadZone.addEventListener('drop', e => {
        const file = e.dataTransfer.files[0];
        if (file) {
            fileInput.files = e.dataTransfer.files;
            actualizarInfoArchivo(file);
            mostrarPreview(file);
        }
    });

    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) {
            actualizarInfoArchivo(file);
            mostrarPreview(file);
        }
    });

    // ==================== L√≥gica AWS ====================

    // ‚ÄúLogin‚Äù: configurar AWS con credenciales y cambiar de vista
    function configurarAWS() {
        const accessKey    = document.getElementById('accessKey').value.trim();
        const secretKey    = document.getElementById('secretKey').value.trim();
        const sessionToken = document.getElementById('sessionToken').value.trim();

        if (!accessKey || !secretKey || !sessionToken) {
            alert("Por favor llena todos los campos de credenciales.");
            return;
        }

        AWS.config.update({
            region: REGION,
            credentials: new AWS.Credentials(accessKey, secretKey, sessionToken)
        });

        s3        = new AWS.S3();
        docClient = new AWS.DynamoDB.DocumentClient();
        awsConfigured = true;

        // Cambiar de vista: ocultar login, mostrar app principal
        viewLogin.style.display = 'none';
        viewMain.style.display  = 'grid';

        setStatus('AWS configurado. Listo para subir im√°genes.', 'success');
        alert("Credenciales configuradas correctamente. Bienvenido a la app.");
    }

    // Subir imagen a S3 y comenzar polling a DynamoDB
    async function subirImagen() {
        if (!awsConfigured) {
            alert("Primero inicia sesi√≥n con tus credenciales de AWS.");
            return;
        }

        const file = fileInput.files[0];

        if (!file) {
            alert("Selecciona una imagen primero.");
            return;
        }

        if (!s3 || !docClient) {
            alert("Configura las credenciales de AWS antes de subir la imagen.");
            return;
        }

        btnAnalizar.disabled = true;
        errorText.textContent = '';
        setStatus('Subiendo imagen a S3...', 'loading');

        const nombreArchivo = file.name;

        try {
            await s3.putObject({
                Bucket: BUCKET_ENTRADA,
                Key: nombreArchivo,
                Body: file,
                ContentType: file.type
            }).promise();

            setStatus('Imagen subida. Esperando a que Lambda procese...', 'loading');
            resultado.className = 'empty-state';
            resultado.textContent = "Esperando resultados desde DynamoDB...";

            pollDynamoDB(nombreArchivo);
        } catch (err) {
            console.error(err);
            setStatus('Error al subir la imagen.', 'error');
            errorText.textContent = err.message || 'Error desconocido al subir a S3.';
            btnAnalizar.disabled = false;
        }
    }

    // Polling a DynamoDB (cada 2s hasta 10 intentos)
    function pollDynamoDB(nombreArchivo) {
        let intentos = 0;
        const maxIntentos = 10;

        const intervalo = setInterval(async () => {
            intentos++;
            setStatus(`Consultando DynamoDB (Intento ${intentos}/${maxIntentos})...`, 'loading');

            try {
                const params = {
                    TableName: TABLA_DYNAMO,
                    Key: { 'id_archivo': nombreArchivo }
                };
                const data = await docClient.get(params).promise();
                console.log("Respuesta DynamoDB:", data);

                if (data.Item) {
                    clearInterval(intervalo);
                    setStatus('Procesamiento completado. Resultados obtenidos.', 'success');

                    let etiquetas = data.Item.contenido;
                    if (!Array.isArray(etiquetas)) {
                        if (typeof etiquetas === 'string') {
                            try {
                                const parsed = JSON.parse(etiquetas.replace(/'/g, '"'));
                                if (Array.isArray(parsed)) etiquetas = parsed;
                            } catch (e) {}
                        } else if (etiquetas && typeof etiquetas === 'object') {
                            etiquetas = Object.values(etiquetas);
                        }
                    }
                    if (!Array.isArray(etiquetas)) etiquetas = [String(etiquetas)];

                    resultado.className = '';
                    resultado.innerHTML =
                        `<ul>${etiquetas.map(e => `<li>${e}</li>`).join('')}</ul>`;

                    btnAnalizar.disabled = false;
                }
            } catch (err) {
                console.log("A√∫n no est√° listo o error consultando DynamoDB:", err);
            }

            if (intentos >= maxIntentos) {
                clearInterval(intervalo);
                setStatus('Tiempo de espera agotado. Revisa DynamoDB manualmente.', 'error');
                resultado.className = 'empty-state';
                resultado.textContent = 'No se recibieron resultados a tiempo.';
                btnAnalizar.disabled = false;
            }
        }, 2000);
    }
</script>
</body>
</html>
